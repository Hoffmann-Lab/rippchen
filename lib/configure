#!/usr/bin/env bash
# (c) Konstantin Riege

configure::instances_by_threads(){
	local funcname=${FUNCNAME[0]}
	_usage(){
		commander::printerr <<- EOF
			$funcname usage:
			-i <instances> | number of all
			-t <threads>   | per instance targeted
			-T <threads>   | available
		EOF
		return 0
	}

	local OPTIND arg mendatory instances ithreads maxthreads
	while getopts 'i:t:T:m:' arg; do
		case $arg in
			i)	((mendatory++)); instances=$OPTARG;;
			t)	((mendatory++)); ithreads=$OPTARG;;
			T)	((mendatory++)); maxthreads=$OPTARG;;
			*)	_usage; return 1;;
		esac
	done
	[[ $mendatory -lt 3 ]] && _usage && return 1

	[[ $ithreads -gt $maxthreads ]] && ithreads=$maxthreads
	[[ $instances -gt $((maxthreads/ithreads)) ]] && instances=$((maxthreads/ithreads))
	ithreads=$((maxthreads/instances))

	echo "$instances $ithreads"
	return 0
}

configure::instances_by_memory(){
	local funcname=${FUNCNAME[0]}
	_usage(){
		commander::printerr <<- EOF
			$funcname usage:
			-t <threads> | available
			-m <memory>  | per instance maximum
		EOF
		return 0
	}

	local OPTIND arg mendatory threads memory
	while getopts 'i:t:T:m:' arg; do
		case $arg in
			t)	((mendatory++)); threads=$OPTARG;;
			m)	((mendatory++)); memory=$OPTARG;;
			*)	_usage; return 1;;
		esac
	done
	[[ $mendatory -lt 2 ]] && _usage && return 1

	local maxmemory=$(grep -F -i memavailable /proc/meminfo | awk '{printf("%d",$2*0.9/1024)}')
	local instances=$((maxmemory/memory))
	[[ $instances= -gt $threads ]] && instances=$threads
	local ithreads=$((threads/instances))

	echo "$instances $ithreads"
	return 0
}

configure::jvm(){
	local funcname=${FUNCNAME[0]}
	_usage(){
		commander::printerr <<- EOF
			$funcname usage:
			-i <instances> | number of all
			-t <threads>   | per instance targeted
			-T <threads>   | available
			-m <memory>    | per instance maximum
		EOF
		return 0
	}

	local OPTIND arg mendatory instances ithreads maxthreads memory
	while getopts 'i:t:T:m:' arg; do
		case $arg in
			i)	((mendatory++)); instances=$OPTARG;;
			t)	((mendatory++)); ithreads=$OPTARG;;
			T)	((mendatory++)); maxthreads=$OPTARG;;
			m)	((mendatory++)); memory=$OPTARG;;
			*)	_usage; return 1;;
		esac
	done
	[[ $mendatory -lt 4 ]] && _usage && return 1

	[[ $ithreads -gt $maxthreads ]] && ithreads=$maxthreads
	[[ $instances -gt $((maxthreads/ithreads)) ]] && instances=$((maxthreads/ithreads))
	ithreads=$((maxthreads/instances))

	local jmem jgct jcgct maxmemory=$(grep -F -i memavailable /proc/meminfo | awk '{printf("%d",$2*0.9/1024)}')
	jmem=$((maxmemory/instances))
	[[ $jmem -gt $memory ]] && jmem=$memory
	jgct=$(((3+5*ithreads/8)/instances))
	[[ $jgct -eq 0 ]] && jgct=1
	jcgct=$((jgct/4))
	[[ $jcgct -eq 0 ]] && jcgct=1

	echo "$instances $ithreads $jmem $jgct $jcgct"
	return 0
}
